<!DOCTYPE html>
<html lang="pt-PT">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Glide</title>
    <link rel="shortcut icon" href="icon.png" type="image/x-icon">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@600;900&display=swap');

        body {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
            font-family: 'Orbitron', sans-serif;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 480px;
            height: 100%;
            max-height: 100vh;
            background: #000;
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.1);
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
        }

        .hud-bar {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            width: 90%;
            justify-content: space-between;
            pointer-events: none;
        }

        .hud-item {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #0ff;
            color: #fff;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 13px;
            box-shadow: 0 0 5px #0ff;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .leader-box {
            border-color: #ffd700;
            color: #ffd700;
            box-shadow: 0 0 10px #ffd700;
        }

        .icon {
            font-size: 16px;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            padding-top: 15%;
            align-items: center;
            pointer-events: auto;
            transition: opacity 0.3s;
        }

        .hidden {
            opacity: 0;
            pointer-events: none;
            display: none !important;
        }

        h1 {
            font-size: 36px;
            color: #fff;
            text-shadow: 0 0 20px #0ff;
            text-align: center;
            margin-bottom: 20px;
            line-height: 1.2;
        }

        p {
            color: #aaa;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: center;
        }

        .custom-area {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 20px;
            border: 1px solid #333;
            text-align: center;
            width: 85%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        label {
            display: block;
            color: #0ff;
            margin-bottom: 5px;
            font-size: 12px;
            letter-spacing: 1px;
            margin-top: 15px;
        }

        input[type="text"],
        select {
            background: #000;
            border: 2px solid #555;
            color: #fff;
            padding: 12px;
            font-family: 'Orbitron';
            font-size: 16px;
            text-align: center;
            width: 100%;
            border-radius: 10px;
            outline: none;
            box-sizing: border-box;
        }

        input[type="text"]:focus,
        select:focus {
            border-color: #0ff;
        }

        .play-btn {
            background: linear-gradient(45deg, #00ccff, #0066ff);
            border: none;
            color: white;
            padding: 15px 0;
            width: 100%;
            font-size: 18px;
            font-family: 'Orbitron';
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 0 15px #00ccff;
            margin-top: 25px;
        }

        .play-btn.join {
            background: linear-gradient(45deg, #ff00ff, #9900ff);
            box-shadow: 0 0 15px #ff00ff;
        }

        .play-btn.leave {
            background: #333;
            box-shadow: 0 0 10px #000;
            margin-top: 15px;
            padding: 12px 0;
            font-size: 14px;
        }

        .play-btn.start {
            background: linear-gradient(45deg, #00ff00, #009900);
            box-shadow: 0 0 20px #00ff00;
        }

        .play-btn:active {
            transform: scale(0.95);
        }

        .colors {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
        }

        .c-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid #333;
            cursor: pointer;
        }

        .c-btn.selected {
            border-color: #fff;
            transform: scale(1.15);
            box-shadow: 0 0 15px currentColor;
        }

        .room-code-display {
            font-size: 32px;
            color: #ffd700;
            letter-spacing: 5px;
            background: rgba(255, 215, 0, 0.1);
            padding: 15px;
            border-radius: 12px;
            border: 1px dashed #ffd700;
            display: inline-block;
            margin: 15px 0;
        }

        .player-list {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 10px;
            text-align: left;
            border: 1px solid #555;
            min-height: 80px;
            margin-bottom: 10px;
        }

        .lobby-player {
            color: #fff;
            padding: 5px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .lobby-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 5px currentColor;
        }

        .rank-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 5px;
            padding: 10px;
            border-radius: 8px;
            border-left: 3px solid transparent;
        }

        .rank-row.dead {
            opacity: 0.5;
            filter: grayscale(1);
        }

        .rank-row.winner {
            border-left-color: #ffd700;
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.1), transparent);
        }

        .rank-pos {
            font-weight: bold;
            width: 25px;
            color: #aaa;
        }

        .rank-name {
            flex: 1;
            text-align: left;
            font-weight: bold;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .rank-score {
            color: #0ff;
            font-weight: bold;
        }

        #countdown-number {
            font-size: 120px;
            color: #0ff;
            text-shadow: 0 0 30px #0ff;
            margin: 0;
        }

        #countdown-label {
            font-size: 20px;
            color: #fff;
            letter-spacing: 5px;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div id="game-container">
        <div id="ui-layer">
            <div class="hud-bar" id="game-hud">
                <div class="hud-item"><span class="icon">üë•</span> <span id="alive-txt">0</span></div>
                <div class="hud-item leader-box"><span class="icon">üëë</span> <span id="leader-txt">---</span></div>
                <div class="hud-item"><span class="icon">üèÜ</span> <span id="score-txt">0</span></div>
            </div>

            <div id="profile-screen" class="screen">
                <h1>NEON GLIDE</h1>
                <div class="custom-area">
                    <label>SEU NOME</label>
                    <input type="text" id="player-name" value="Player 1" maxlength="10">
                    <label>SUA COR</label>
                    <div class="colors" id="color-options"></div>
                    <button class="play-btn" onclick="goToRoomScreen()">CONTINUAR</button>
                </div>
            </div>

            <div id="room-screen" class="screen hidden">
                <h1>MODO DE JOGO</h1>
                <div class="custom-area">
                    <label>DIFICULDADE DA SALA</label>
                    <select id="room-diff" style="margin-bottom: 15px;">
                        <option value="facil">üü¢ F√°cil</option>
                        <option value="medio" selected>üü° M√©dia</option>
                        <option value="hard">üî¥ Hardcore</option>
                    </select>

                    <button class="play-btn" style="margin-top: 5px;" onclick="createRoom()">CRIAR SALA</button>

                    <hr style="border-color: #333; margin: 20px 0;">

                    <label>ENTRAR EM SALA</label>
                    <input type="text" id="join-code" placeholder="C√ìDIGO"
                        style="text-transform:uppercase; letter-spacing: 2px;">
                    <button class="play-btn join" onclick="joinRoom()">ENTRAR</button>

                    <button class="play-btn leave" onclick="goToProfileScreen()">VOLTAR</button>
                </div>
            </div>

            <div id="lobby-screen" class="screen hidden">
                <h1>LOBBY</h1>
                <div class="custom-area">
                    <label>C√ìDIGO DA SALA</label>
                    <div class="room-code-display" id="display-room-code">---</div>

                    <label>JOGADORES</label>
                    <div class="player-list" id="lobby-player-list"></div>

                    <div id="host-controls" class="hidden">
                        <button class="play-btn start" onclick="startGameHost()">INICIAR PARTIDA</button>
                    </div>
                    <div id="guest-controls" class="hidden">
                        <p style="color: #0ff; font-size: 12px; margin-top: 15px;">Aguardando L√≠der iniciar...</p>
                    </div>
                    <button class="play-btn leave" onclick="leaveGame()">SAIR</button>
                </div>
            </div>

            <div id="countdown-screen" class="screen hidden">
                <h1 id="countdown-number">8</h1>
                <p id="countdown-label">PREPAREM-SE</p>
            </div>

            <div id="ranking-screen" class="screen hidden">
                <h1>CLASSIFICA√á√ÉO</h1>
                <div class="custom-area rank-popup-container">
                    <div id="final-ranking-list" style="max-height: 200px; overflow-y: auto;">
                    </div>

                    <button id="btn-return-lobby" class="play-btn start hidden" onclick="returnToLobbyHost()">NOVA
                        RODADA</button>

                    <p id="guest-wait-msg" class="hidden" style="color: #aaa; font-size: 12px; margin-top: 15px;">
                        Aguardando fim da rodada...</p>

                    <button class="play-btn leave" onclick="leaveGame()">SAIR DA SALA</button>
                </div>
            </div>
        </div>

        <canvas id="canvas"></canvas>
    </div>

    <script src="/socket.io/socket.io.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io();
            const canvas = document.getElementById('canvas');
            const gameContainer = document.getElementById('game-container');
            const ctx = canvas.getContext('2d');
            const aliveEl = document.getElementById('alive-txt');
            const scoreEl = document.getElementById('score-txt');
            const leaderEl = document.getElementById('leader-txt');

            const profileScreen = document.getElementById('profile-screen');
            const roomScreen = document.getElementById('room-screen');
            const lobbyScreen = document.getElementById('lobby-screen');
            const countdownScreen = document.getElementById('countdown-screen');
            const rankingScreen = document.getElementById('ranking-screen');
            const gameHud = document.getElementById('game-hud');
            const rankListEl = document.getElementById('final-ranking-list');
            const countdownNumEl = document.getElementById('countdown-number');

            let isRunning = false;
            let isAmIHost = false;
            let frames = 0;
            let score = 0;
            let pipesCreated = 0;
            let rankingData = [];

            const DIFF_SETTINGS = {
                facil: { grav: 0.20, jump: 3.5, speed: 2.5, gap: 200, spawn: 120 },
                medio: { grav: 0.22, jump: 3.6, speed: 2.8, gap: 180, spawn: 110 },
                hard: { grav: 0.28, jump: 4.2, speed: 3.5, gap: 140, spawn: 80 }
            };
            let currentDiff = DIFF_SETTINGS['medio'];
            let mapBlueprint = [];

            const neonColors = ['#00ffff', '#ff00ff', '#00ff00', '#ffff00', '#ff3300'];
            let selectedColor = neonColors[0];

            const colorContainer = document.getElementById('color-options');
            neonColors.forEach((c, i) => {
                let btn = document.createElement('div');
                btn.className = `c-btn ${i === 0 ? 'selected' : ''}`;
                btn.style.backgroundColor = c;
                btn.onclick = () => {
                    document.querySelectorAll('.c-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected'); selectedColor = c;
                };
                colorContainer.appendChild(btn);
            });

            function resize() {
                canvas.width = gameContainer.clientWidth;
                canvas.height = gameContainer.clientHeight;
            }
            window.addEventListener('resize', resize);
            resize();

            let localPlayer = null;
            let remotePlayers = {};
            let pipes = [];

            class LocalBall {
                constructor(name, color) {
                    this.name = name; this.color = color;
                    this.x = 100; this.y = canvas.height / 2;
                    this.distance = 0; this.radius = 15; this.velocity = 0; this.dead = false;
                }
                update() {
                    if (this.dead) return;
                    this.velocity += currentDiff.grav;
                    this.y += this.velocity;
                    if (this.y + this.radius > canvas.height || this.y - this.radius < 0) this.die();
                    this.distance += currentDiff.speed;
                    socket.emit('move', { y: this.y, dist: this.distance });
                }
                draw() {
                    if (this.dead) return;
                    drawBall(this.x, this.y, this.radius, this.color, this.name, true);
                }
                flap() { if (!this.dead) this.velocity = -currentDiff.jump; }
                die() {
                    this.dead = true;
                    socket.emit('died');
                    updateOnlineCounter();
                    showRankingPopup();
                }
            }

            function drawBall(x, y, r, c, name, isLocal) {
                ctx.save(); ctx.translate(x, y);
                ctx.shadowBlur = isLocal ? 20 : 10; ctx.shadowColor = c; ctx.fillStyle = c;
                if (!isLocal) ctx.globalAlpha = 0.6;
                ctx.beginPath(); ctx.arc(0, 0, r, 0, Math.PI * 2); ctx.fill();
                ctx.shadowBlur = 0; ctx.fillStyle = "rgba(255, 255, 255, 0.4)";
                ctx.beginPath(); ctx.arc(-5, -5, 5, 0, Math.PI * 2); ctx.fill();
                ctx.restore();
                ctx.globalAlpha = 1; ctx.fillStyle = "#fff";
                ctx.font = isLocal ? "bold 12px Orbitron" : "10px Orbitron";
                ctx.textAlign = "center"; ctx.fillText(name, x, y - 25);
            }

            window.goToRoomScreen = () => { profileScreen.classList.add('hidden'); roomScreen.classList.remove('hidden'); };
            window.goToProfileScreen = () => { roomScreen.classList.add('hidden'); profileScreen.classList.remove('hidden'); };

            window.createRoom = () => {
                const chars = "ABCDEFGHJKMNPQRSTUVWXYZ23456789";
                let code = "";
                for (let i = 0; i < 5; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));

                let selectedDiff = document.getElementById('room-diff').value;
                joinServerRoom(code, selectedDiff);
            };

            window.joinRoom = () => {
                let code = document.getElementById('join-code').value.toUpperCase().trim();
                if (code) joinServerRoom(code, 'medio');
            };

            function joinServerRoom(code, diff) {
                let pName = document.getElementById('player-name').value || "Piloto";
                socket.emit('joinOrCreateRoom', { roomId: code, difficulty: diff, name: pName, color: selectedColor });
                roomScreen.classList.add('hidden');
            }

            window.startGameHost = () => socket.emit('startGame');
            window.returnToLobbyHost = () => socket.emit('returnToLobby');
            window.leaveGame = () => location.reload();

            socket.on('roomError', (msg) => { alert(msg); roomScreen.classList.remove('hidden'); });

            socket.on('roomJoined', (data) => {
                mapBlueprint = data.blueprint;
                isAmIHost = data.isHost;
                currentDiff = DIFF_SETTINGS[data.difficulty];

                document.getElementById('display-room-code').innerText = data.roomId;
                lobbyScreen.classList.remove('hidden');

                document.getElementById('host-controls').classList.toggle('hidden', !isAmIHost);
                document.getElementById('guest-controls').classList.toggle('hidden', isAmIHost);

                localPlayer = new LocalBall(document.getElementById('player-name').value, selectedColor);
            });

            socket.on('lobbyUpdate', (players) => {
                const list = document.getElementById('lobby-player-list');
                list.innerHTML = '';
                for (let id in players) {
                    let p = players[id];
                    list.innerHTML += `<div class="lobby-player"><span class="lobby-color" style="background:${p.color}"></span>${p.name} ${p.isHost ? 'üëë' : ''}</div>`;
                }
            });

            socket.on('gameStarted', () => {
                lobbyScreen.classList.add('hidden');
                rankingScreen.classList.add('hidden');
                countdownScreen.classList.remove('hidden');

                let count = 8;
                countdownNumEl.innerText = count;

                const timer = setInterval(() => {
                    count--;
                    if (count > 0) {
                        countdownNumEl.innerText = count;
                    } else {
                        clearInterval(timer);
                        countdownScreen.classList.add('hidden');

                        pipes = []; score = 0; frames = 0; pipesCreated = 0; scoreEl.innerText = "0";
                        gameHud.style.opacity = 1;
                        isRunning = true;
                        loop();
                    }
                }, 1000);
            });

            socket.on('returnedToLobby', (data) => {
                isRunning = false;
                mapBlueprint = data.blueprint;
                rankingScreen.classList.add('hidden');
                lobbyScreen.classList.remove('hidden');
                pipes = []; score = 0;

                let pName = document.getElementById('player-name').value;
                localPlayer = new LocalBall(pName, selectedColor);
                for (let id in remotePlayers) { remotePlayers[id].dead = false; remotePlayers[id].dist = 0; remotePlayers[id].y = 300; }
                updateOnlineCounter();
            });

            socket.on('updateLeader', (data) => {
                leaderEl.innerText = data.top.score >= 0 ? data.top.name : "---";
                rankingData = data.list;
                if (!rankingScreen.classList.contains('hidden')) {
                    renderFinalRanking();
                }
            });

            socket.on('roundOver', () => {
                if (isAmIHost) {
                    document.getElementById('btn-return-lobby').classList.remove('hidden');
                    document.getElementById('guest-wait-msg').classList.add('hidden');
                } else {
                    document.getElementById('btn-return-lobby').classList.add('hidden');
                    document.getElementById('guest-wait-msg').classList.remove('hidden');
                }
            });

            socket.on('currentPlayers', (list) => { for (let id in list) if (id !== socket.id) remotePlayers[id] = list[id]; updateOnlineCounter(); });
            socket.on('newPlayer', (p) => { remotePlayers[p.id] = p; updateOnlineCounter(); });
            socket.on('removePlayer', (id) => { delete remotePlayers[id]; updateOnlineCounter(); });
            socket.on('playerDied', (id) => { if (remotePlayers[id]) remotePlayers[id].dead = true; updateOnlineCounter(); });
            socket.on('updatePlayer', (d) => { if (remotePlayers[d.id]) { remotePlayers[d.id].y = d.y; remotePlayers[d.id].dist = d.dist; } });

            function updateOnlineCounter() {
                let count = (localPlayer && !localPlayer.dead) ? 1 : 0;
                for (let id in remotePlayers) if (!remotePlayers[id].dead) count++;
                aliveEl.innerText = count;
            }

            function showRankingPopup() {
                gameHud.style.opacity = 0;
                document.getElementById('btn-return-lobby').classList.add('hidden');
                document.getElementById('guest-wait-msg').classList.remove('hidden');
                document.getElementById('guest-wait-msg').innerText = "Voc√™ caiu! Aguardando o fim da rodada...";

                renderFinalRanking();
                rankingScreen.classList.remove('hidden');
            }

            function renderFinalRanking() {
                rankListEl.innerHTML = '';
                rankingData.forEach((p, i) => {
                    let isDead = p.dead ? 'dead' : '';
                    let isWinner = (i === 0 && rankingData.length > 1) ? 'winner' : '';
                    let points = Math.floor(p.dist / 100);

                    rankListEl.innerHTML += `
                        <div class="rank-row ${isDead} ${isWinner}">
                            <span class="rank-pos"># ${i + 1}</span>
                            <span class="rank-name" style="color: ${p.color}">${p.name}</span>
                            <span class="rank-score">${points}pts</span>
                        </div>
                    `;
                });
            }

            function updatePipes(cameraDist) {
                if (frames % currentDiff.spawn === 0) {
                    let val = mapBlueprint[pipesCreated % mapBlueprint.length];
                    let y = val * (canvas.height - 300) + 100;
                    pipes.push({ x: canvas.width + cameraDist, y: y });
                    pipesCreated++;
                }
                for (let i = 0; i < pipes.length; i++) {
                    let p = pipes[i];
                    p.x -= currentDiff.speed;
                    let drawX = p.x - cameraDist;

                    if (localPlayer && !localPlayer.dead) {
                        let screenX = (p.x - cameraDist) + 100;
                        ctx.shadowBlur = 15; ctx.shadowColor = "#00ffff"; ctx.fillStyle = "rgba(0, 255, 255, 0.2)";
                        ctx.fillRect(screenX, 0, 60, p.y);
                        ctx.fillRect(screenX, p.y + currentDiff.gap, 60, canvas.height);

                        if (100 + 15 > screenX && 100 - 15 < screenX + 60) {
                            if (localPlayer.y - 15 < p.y || localPlayer.y + 15 > p.y + currentDiff.gap) localPlayer.die();
                        }
                        if (screenX + 60 < 100 && !p.passed) {
                            score++; scoreEl.innerText = score; p.passed = true;
                            socket.emit('scoreUpdate', score);
                        }
                    }
                    if (drawX < -2000) { pipes.shift(); i--; }
                }
            }

            function loop() {
                if (!isRunning) return;
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                let cameraDist = (localPlayer && !localPlayer.dead) ? localPlayer.distance : localPlayer.distance;

                let offset = -(cameraDist % 50);
                ctx.strokeStyle = "rgba(0, 255, 255, 0.1)"; ctx.lineWidth = 1; ctx.beginPath();
                for (let i = offset; i < canvas.width; i += 50) { ctx.moveTo(i, 0); ctx.lineTo(i, canvas.height); }
                ctx.stroke();

                updatePipes(cameraDist);

                for (let id in remotePlayers) {
                    let rp = remotePlayers[id];
                    if (!rp.dead && rp.dist !== undefined) {
                        let relX = 100 + (rp.dist - cameraDist);
                        if (relX > -50 && relX < canvas.width) drawBall(relX, rp.y, 15, rp.color, rp.name, false);
                    }
                }

                if (localPlayer) {
                    localPlayer.update();
                    localPlayer.draw();
                }

                frames++; requestAnimationFrame(loop);
            }

            const action = (e) => {
                if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.classList.contains('c-btn')) return;
                if (e.type === 'touchstart') e.preventDefault();
                if (isRunning && localPlayer && !localPlayer.dead) localPlayer.flap();
            };

            window.addEventListener('mousedown', action);
            window.addEventListener('keydown', (e) => { if (e.code === 'Space') action(e); });
            window.addEventListener('touchstart', action, { passive: false });
        });
    </script>
</body>

</html>